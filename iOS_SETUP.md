# Настройка iOS для сборки на реальном устройстве

## Что такое Target в Xcode?

**Target** (цель) - это конфигурация сборки, которая определяет:
- Какие файлы включать в сборку
- Как подписывать приложение
- Настройки сборки и развертывания
- Bundle Identifier приложения

В проекте Flutter обычно есть один основной target с именем "Runner".

## Шаги по настройке в Xcode

### 1. Откройте проект в Xcode
```bash
cd /Users/keluch/Desktop/coledj/5sem/ASP/flutter_app
open ios/Runner.xcworkspace
```

### 2. Настройте подписание кода (Code Signing)

**Визуальная навигация в Xcode:**

1. **Левая панель (Project Navigator):**
   - В левой панели вы видите файловую структуру проекта
   - **Найдите и кликните на самую верхнюю синюю иконку "Runner"** (это корневой проект)
   - НЕ кликайте на папки Flutter, Runner (папка), Products и т.д.
   - Кликните именно на синюю иконку с названием "Runner" в самом верху

2. **Центральная панель (Target Selection):**
   - После правильного клика на проект в центре должны появиться два раздела:
     - **PROJECT** (с названием "Runner") 
     - **TARGETS** (здесь будет target "Runner" с иконкой приложения)
   - Если ничего не появилось, значит вы кликнули не на тот элемент
   - **Кликните на "Runner" в разделе TARGETS** (не в PROJECT!)

3. **Верхние вкладки:**
   - После выбора target'а появятся вкладки: General, Signing & Capabilities, Resource Tags, etc.
   - **Перейдите на вкладку "Signing & Capabilities"**

4. **Настройки подписания:**
   - **Установите флажок "Automatically manage signing"**
   - **Выберите вашу команду разработчика (Team)** из выпадающего списка
   - Если у вас нет Apple Developer Account, выберите свой личный Apple ID
   - Для публикации в App Store нужен платный аккаунт ($99/год)

### 3. Настройте Bundle Identifier

1. В разделе **"Signing & Capabilities"** найдите **"Bundle Identifier"**
2. Измените его на уникальный (например: `com.yourname.flutterapp`)
3. Убедитесь, что он не конфликтует с существующими приложениями

### 4. Подключите iPhone

1. **Подключите iPhone к Mac** через USB
2. **Разрешите доверие** этому компьютеру на iPhone
   - На iPhone появится диалоговое окно "Доверять этому компьютеру?"
   - Нажмите "Доверять" и введите пароль iPhone если требуется
3. **В Xcode выберите ваше устройство:**
   - Посмотрите на **верхнюю панель Xcode** (рядом с кнопками "Play", "Stop")
   - Там должно быть выпадающее меню с текстом типа "iPhone 16 Pro" или "Any iOS Device"
   - **Кликните на это выпадающее меню**
   - Выберите ваш подключенный iPhone из списка устройств
   - Если iPhone не появился в списке, попробуйте:
     - Переподключить кабель
     - Перезапустить Xcode
     - Убедиться, что iPhone разблокирован

### 5. Первая сборка

1. **Нажмите кнопку "Play"** в Xcode или используйте ⌘+R
2. **При первой сборке могут появиться диалоги:**
   - **Запрос пароля для связки ключей** - введите пароль вашего Mac
   - **Диалог "Preparing"** с названием сертификата - НЕ нажимайте Cancel, дождитесь завершения
   - Xcode автоматически создает сертификат разработчика и профиль подготовки
3. **При первом запуске на iPhone** появится сообщение о недоверенном разработчике
4. **На iPhone перейдите в**: Настройки → Основные → VPN и управление устройствами → Профили разработчика
5. **Найдите ваш профиль** и нажмите "Доверять"

**Важно:** Первая сборка может занять несколько минут из-за создания сертификатов!

### 6. Альтернативная сборка через Flutter

После настройки в Xcode можно собирать через Flutter:

```bash
# Для тестирования на устройстве (debug)
flutter run -d ios --debug

# Для релизной сборки
flutter build ios --release
```

## Переключение конфигурации API

### Для реального устройства
В файле `lib/config/api_config.dart` установите:
```dart
static const Environment currentEnvironment = Environment.device;
```

### Для симулятора
```dart
static const Environment currentEnvironment = Environment.iOSSimulator;
```

## Важные моменты

1. **Сетевое подключение**: iPhone и Mac должны быть в одной Wi-Fi сети
2. **IP-адрес**: Убедитесь, что IP в `api_config.dart` актуальный
3. **Сервер**: NestJS сервер должен быть запущен (`npm run start:dev`)
4. **Firewall**: Убедитесь, что порт 3000 не заблокирован

## Проверка подключения

На iPhone можете проверить доступность сервера через Safari:
```
http://192.168.1.90:3000
```

Должно отобразиться "Hello World!"

## Решение проблем

### Приложение не запускается (вылетает при открытии)

**Причина 1:** Профиль разработчика не доверенный

**Решение:**
1. **На iPhone:** Настройки → Основные → VPN и управление устройствами
2. **Найдите раздел "Профили разработчика"** или "Developer App"
3. **Найдите ваш профиль** (обычно с вашим Apple ID или названием команды)
4. **Нажмите на профиль → "Доверять [имя разработчика]"**
5. **Подтвердите доверие** в появившемся диалоге

**Причина 2:** Ошибка в коде или конфигурации

**Диагностика через Flutter:**
```bash
cd /Users/keluch/Desktop/coledj/5sem/ASP/flutter_app
flutter run -d ios --debug
```

**Диагностика через Xcode:**
1. Откройте проект: `open ios/Runner.xcworkspace`
2. Запустите через Xcode (⌘+R)
3. Посмотрите на ошибки в консоли Xcode

**Возможные причины и решения:**

1. **Проблема с сетевыми разрешениями:**
   - В iOS приложения должны запрашивать разрешение на сетевые запросы
   - Проверьте файл `ios/Runner/Info.plist`

2. **Проблема с HTTP (не HTTPS):**
   - iOS блокирует HTTP соединения по умолчанию
   - Нужно добавить исключение в Info.plist

3. **Проблема с API URL:**
   - Убедитесь, что `Environment.device` в `api_config.dart`
   - IP-адрес должен быть правильным

### Приложение не подключается к серверу

1. **Проверьте Wi-Fi:** iPhone и Mac в одной сети
2. **Проверьте IP-адрес:** Убедитесь, что в `api_config.dart` указан правильный IP
3. **Проверьте сервер:** `curl http://192.168.1.90:3000` должен возвращать "Hello World!"
4. **Проверьте firewall:** Убедитесь, что порт 3000 не заблокирован
